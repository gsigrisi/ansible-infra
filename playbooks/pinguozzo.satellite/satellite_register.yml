---
- name: Get Satellite Registration command
  hosts: localhost
  gather_facts: false
  vars:
    ansible_become: "no"
    ansible_connection: "local"

  vars_files:
    - "{{ playbook_dir }}/../../vaults/{{ env }}-vault.yml"

  roles:
    - role: "{{ playbook_dir }}/../../roles/satellite_registration_command"

      vars:
        satellite_registration_command_url: "{{ satellite_server_url }}"
        satellite_registration_command_username: "{{ satellite_username }}"
        satellite_registration_command_password: "{{ satellite_password }}"
        satellite_registration_command_organization: "{{ satellite_organization }}"
        satellite_registration_command_location: "{{ satellite_location }}"
        satellite_registration_command_hostgroup: "RHEL8 NET_apps"
        satellite_registration_command_activation_keys:
          - ak-rhel8


- name: Register hosts on the Satellite using the command generated by the Registration Command
  hosts: "{{ targeted_host }}"
  gather_facts: false
  vars:
    ansible_become: "yes"
  tasks:
    - name: Execute Satellite registration command
      shell: "export LANG=en && {{ hostvars['localhost']['satellite_registration_command'] }}"
      when: hostvars['localhost']['satellite_registration_command'] is defined
      register: satellite_registration_command_execution_result
 
    - name: Show output
      debug:
        var: satellite_registration_command_execution_result
