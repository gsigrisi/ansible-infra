---
- name: publish cvs
  hosts: localhost

  vars_files:
    - "{{ playbook_dir }}/../../../vaults/{{ env }}-vault.yml"
    - "{{ playbook_dir }}/../../../vars/satellite-vars.yml"

  vars:

  pre_tasks:
    - name: show LFE
      debug: msg="{{ item }}"
      loop: "{{ satellite_composite_content_views }}"
      tags: lfe

  roles:
    - role: redhat.satellite.content_view_publish

  tasks:
    - name: "Promote composite content views"
      block:
      - name: "Promote composite content views"
        redhat.satellite.content_view_version:
          username: "{{ satellite_username | default(omit) }}"
          password: "{{ satellite_password | default(omit) }}"
          server_url: "{{ satellite_server_url | default(omit) }}"
          validate_certs: "{{ satellite_validate_certs | default(omit) }}"
          content_view: "{{ item.name }}"
          organization: "{{ satellite_organization }}"
          lifecycle_environments: "{{ item.lfe }}"
        loop: "{{ satellite_composite_content_views }}"
            #loop: "{{ lookup('ansible.builtin.dict', satellite_composite_content_views, wantlist=True) }}"
      tags: promote

    - name: "Promote infra content views"
      block:
      - name: "Promote infra content views"
        redhat.satellite.content_view_version:
          username: "{{ satellite_username | default(omit) }}"
          password: "{{ satellite_password | default(omit) }}"
          server_url: "{{ satellite_server_url | default(omit) }}"
          validate_certs: "{{ satellite_validate_certs | default(omit) }}"
          content_view: "{{ item.value.name }}"
          organization: "{{ satellite_organization }}"
          lifecycle_environments: "{{ item.value.lfe }}"
        loop: "{{ lookup('ansible.builtin.dict', satellite_infra_content_views, wantlist=True) }}"
      tags: promote,promote_infra
